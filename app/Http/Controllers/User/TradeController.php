<?php

namespace App\Http\Controllers\User;

use App\Http\Controllers\Controller;
use App\Models\DerivativeSell;
use App\Models\LimitBuySell;
use Carbon\Carbon;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Foundation\Auth\User;
use Illuminate\Http\Request;

use Illuminate\Support\Facades\Auth;

use App\Libraries\Bitfinex;
use App\Models\Currency;
use App\Models\UserWallet;
use App\Models\TransactionHistory;
use App\Models\LockedSavingsSetting;
use App\Models\LockedSaving;
use App\Models\Leverage_Wallet;
use Illuminate\Support\Facades\DB;
use mysql_xdevapi\Exception;
use function PHPUnit\Framework\countOf;

class TradeController extends Controller
{
    public function index(Request $request)
    {
        $data['userInfo'] = UserWallet::where('user_id', Auth::user()->id)->get();
//        dd($data['userInfo'] );
        $currency = array();
        $data['currency'] = 0;
        if(isset($request->type)){
            $data['type'] = $request->type;
            $leverageAmount= Leverage_Wallet::select('currency_id')
                                                        ->selectRaw('sum(amount) as total')
                                                        ->where('user_id', Auth::id())
                                                        ->groupBy('currency_id')
                                                        ->with('currencyName')
                                                        ->get();

            for ($i = 0 ; $i < count($leverageAmount); $i++){
                $currencyInfo = array();
                $currencyInfo["id"] = $leverageAmount[$i]->currency_id;
                $currencyInfo["amount"] = $leverageAmount[$i]->total;
                $currency[$leverageAmount[$i]->currencyName->name] = $currencyInfo;

            }
            $data['currency'] = $currency;


            // dd($data);
            return view('user.trade.index', $data);
        }

        return view('user.trade.index', $data);
    }

    public function finance(Request $request)
    {
        $data['settings'] = LockedSavingsSetting::get();
        //dummy coin data grab
        //$id = Currency::where('name', 'ADA')->pluck('id');
        $wallet = UserWallet::where('user_id', Auth::id())->groupBy('currency_id')->get();
        $coinBalance = array();
        for ($i = 0; $i<count($wallet); $i++){
            $coinBalance[$wallet[$i]->currency_id] = $wallet[$i]->balance;
        }
        $data['dummy_coin_balance'] = $coinBalance;
        $data['history'] = LockedSaving::where('user_id', Auth::user()->id)->orderBy('id', 'DESC')->get();
        $data['total'] = 0;
        $data['lockedFinanceSettings'] = LockedSavingsSetting::with('currency')->get();
//        dd( $data['lockedFinanceSettings']);

        return view('user.trade.finance', $data);
    }

    public function insertFinance(Request $request)
    {
    //    dd($request);
        try {

            $date = date('Y-m-d');
            $authUserId = Auth::user()->id;
            $currency = Currency::where('id', $request->coinId)->first();
            $UserWallet = UserWallet::where('user_id', $authUserId)->where('currency_id', $currency->id)->first();
            $UserWalletBalance = UserWallet::select('balance', 'currency_id')->where('user_id', $authUserId)->where('currency_id', $currency->id)->first();

            $lockedInvest = new LockedSaving();
            $lockedInvest->user_id = $authUserId;
            $lockedInvest->plan_id = $request->plan;
            $lockedInvest->lot_count = $request->lot;
            $lockedInvest->value_date = $date;
            $lockedInvest->redemption_date = date('Y-m-d', strtotime($date . ' + ' . $request->redemptionTime . ' days'));
            $lockedInvest->expected_interest = $request->expected_interest;
            $lockedInvest->currency_id = $request->coinId;
            $lockedInvest->lot_size = $request->coinLotSize;
            $lockedInvest->save();

            $UserWallet->balance = $UserWalletBalance->balance - $request->totalCoin;
            $UserWallet->save();

        } catch (Exception $e){
            return route('user-trade-finance');
        }
        return redirect()->back();
    }

    public function getChartData(Request $request)
    {
        //dd($request);
        if($request->user_currency == 'MAB'){
             $currency = 'ADA';
        }
        else{
            $currency = $request->user_currency;
        }
       // dd( $request->user_currency);
        if(empty($request->currency)) return response()->json(['status' => false]);
        $Bitfinex = new Bitfinex();
        if($request->currency == 'tMABUSD'){
            $response = $Bitfinex->getCandle('tADAUSD', '','', '' );
            //dd($response);
//            $chartData =array(
//                   array(1621604979000,39252,39821.73222635,39839,39252,417.14195681),
//                   array(1621518579000,39689,39252,39703.38687557,39037,631.40783786),
//                   array(1621432179000,39293,39689,39814,39166,2237.91657036),
//                   array(1621345779000,39622,39292,40192,38651,1351.04102485),
//                   array(1621259379000,40671.06476555,39622,40961,39500,1116.4597083200001),
//                   array(1621172979000,40677.57848236,40817,40969.93034879,40531,161.74014193),
//                   array(1621086579000,41352,40685.84590945,41352,40661,165.66093902),
//                   array(1621000179000,41269.78728655,41371,41439,41176,78.63957097),
//                   array(1620913779000,41514.05709619,41263,41689,41148,207.0136384),
//                   array(1620827379000,41589.73268099,41522,41880,41361,120.94050563),
//                   array(1620740979000,41825,41585,41886.12351982,41500,124.1747853),
//            );
//            array_push($response, $chartData);
//            echo "<pre>";
//           print_r($response);
        }
        else{
            $response = $Bitfinex->getCandle($request->currency);
        }

        $balance = UserWallet::whereHas('currency', function($query) use ($currency){
            return $query->where('name', $currency);
        })->where('user_id', Auth::user()->id)->first();
        if($balance) $balance = $balance->balance;
        else $balance = 0;
        return response()->json(['status' => true, 'chartData' => $response, 'balance' => $balance]);
//        if(empty($request->currency)) return response()->json(['status' => false]);
//        if($request->user_currency == 'MAB'){
//            //dd("here");
//            $data=array(
//              'status'=> 'true',
//               'chartData'=>array(
//                   array(1621604979000,39252,39821.73222635,39839,39252,417.14195681),
//                   array(1621518579000,39689,39252,39703.38687557,39037,631.40783786),
//                   array(1621432179000,39293,39689,39814,39166,2237.91657036),
//                   array(1621345779000,39622,39292,40192,38651,1351.04102485),
//                   array(1621259379000,40671.06476555,39622,40961,39500,1116.4597083200001),
//                   array(1621172979000,40677.57848236,40817,40969.93034879,40531,161.74014193),
//                   array(1621086579000,41352,40685.84590945,41352,40661,165.66093902),
//                   array(1621000179000,41269.78728655,41371,41439,41176,78.63957097),
//                   array(1620913779000,41514.05709619,41263,41689,41148,207.0136384),
//                   array(1620827379000,41589.73268099,41522,41880,41361,120.94050563),
//                   array(1620740979000,41825,41585,41886.12351982,41500,124.1747853),
////                   array(1621557000000,41096,41759,42298.12038263,41050.89633089,660.87063806),
////                   array(1621555200000,40590,41097,41227,40556,287.02691063),
////                   array(1621553400000,41050,40561.45427722,41204.70289009,40333,418.38371288),
////                   array(1621551600000,41481.66608132,41050,41732.74851155,40811,401.58357033),
////                   array(1621549800000,40174.26938137,41461,41777,39561,744.8623803),
////                   array(1621548000000,40737,40194.98627007,40750.11617384,40174,123.34672034),
////                   array(1621546200000,40609,40756.48021002,40854.64505691,40569.65258856,72.71850123),
////                   array(1621544400000,40023,40611.39549395,40826.50812788,39727,176.07033407),
////                   array(1621542600000,40482.78311081,40025.55164301,40512,39850,168.10178439),
////                   array(1621540800000,40193,40514,40650,39740,233.2846376),
////                   array(1621539000000,40339,40193,40410,40030.52828761,101.91818627),
////                   array(1621537200000,39882,40318,40439,39565,210.99072409000001),
////                   array(1621535400000,39876,39858,40069,39711,306.49765184),
////                   array(1621533600000,39810.48328473,39815.4491755,39922,39279,328.51776515),
////                   array(1621531800000,39247.99024542,39825.02906729,40169,39194.60857307,360.32757086),
////                   array(1621530000000,39265.40452386,39256.4971431,39639,38793,504.90702199),
////                   array(1621528200000,39851,39320,39917.08523072,38123,1016.28390447),
////                   array(1621526400000,41450.91761115,39851.12474837,41468,38924,1641.22750896),
////                   array(1621524600000,41723.10067257,41417.49317103,41788,41025,638.90834517),
////                   array(1621522800000,41485,41746.10144045,42052.77983148,41396.42354642,322.83974121),
////                   array(1621521000000,41759,41504,42051,41388.49355901,249.81333239),
////                   array(1621519200000,41758.16401607,41759.6420683,42141.19946256,41274,1105.1377781),
////                   array(1621517400000,42297,41758.16401607,42299,41411.65550134,812.10943496),
////                   array(1621515600000,41767,42295,42300,41668,2014.67730851),
////                   array(1621513800000,41788,41767,41950,41501,1358.4328509),
////                   array(1621512000000,40552.8009541,41789,41888,40205,931.57330543),
////                   array(1621510200000,39874.82691099,40573.5315996,40752,39874.82691099,260.3430188),
////                   array(1621508400000,40504.20473662,39858,40578,39833.20375998,376.18741096),
////                   array(1621506600000,40000.24372559,40504,40533,39669,378.65394735),
////                   array(1621504800000,40000.18316211,40020,40300,39539.6023617,416.15112021),
////                   array(1621503000000,39119.92293714,40001,40286,38828,413.48192934),
////                   array(1621501200000,39877.53000021,39140,39935,39092,309.35892494),
////                   array(1621499400000,39798.05647048,39874,39884.11935224,39375,324.16991581),
////                   array(1621497600000,40007.91088948,39781,40297,39582,437.75954394),
////                   array(1621495800000,40707.42685141,40021,40741,39906,252.19757519),
////                   array(1621494000000,39748.68518584,40728,40826,39745.86142388,548.57476068),
////                   array(1621492200000,39415.53874079,39817,40150,39415.53874079,685.03688226),
////                   array(1621490400000,40015.3464834,39415.53874079,40150,39321,569.42074169),
////                   array(1621488600000,39328,40015.3464834,40041,39328,251.4277817),
////                   array(1621486800000,39504.08188132,39328,40000,39252,256.27236312),
////                   array(1621485000000,39671,39527,39692,39228,159.60720176),
////                   array(1621483200000,38393,39674,39859,38261,548.75633785),
////                   array(1621481400000,38472,38381,38477.0466741,37921,154.11468256),
////                   array(1621479600000,38124,38476.13940262,38639,37974,260.30362196),
////                   array(1621477800000,37933.9769674,38124,38327,37584,263.3960533),
////                   array(1621476000000,37015,37924.10383712,38169.57887129,36933.56952624,372.54851032),
////                   array(1621474200000,37213,37023.72569134,37500,36521,770.85435168),
////                   array(1621472400000,35858,37217,37518,35520,1919.31614278),
////                   array(1621470600000,37048.6097574,35864,37206,34985,926.46450728),
////                   array(1621468800000,36733.7221572,37033.04426878,38220,36716,512.85935674),
////                   array(1621467000000,37897.52101576,36733,38383,36682,580.67858414),
////                   array(1621465200000,39113,37886,39288,37720,591.53608428),
//               /*    array(1621463400000,38989,39110,39530,38888.5371413,657.03786835),
//                   array(1621461600000,38818.81388903,38980.48371621,39600,38290.48977792,700.57864137),
//                   array(1621459800000,37740,38810,38975,37740,319.65794022),
//                   array(1621458000000,38326,37701.09624455,38816,37001,624.63216974),
//                   array(1621456200000,39146.14140036,38339,39383,38088,333.78974617),
//                   array(1621454400000,39401,39146.14140036,40050,39145,1561.87164602),
//                   array(1621452600000,38716.49956484,39401,39548.96979626,38161,506.08110336),
//                   array(1621450800000,38072.61994646,38702,39153,37805,511.38995877),
//                   array(1621449000000,38644.30478379,38073.53513167,38850,37676,585.24646086),
//                   array(1621447200000,39438.02390229,38648.88360139,39679,37965,801.66953108),
//                   array(1621445400000,40154,39457.30091977,40173,38955.68970764,1154.28749804),
//                   array(1621443600000,39715,40141.17618324,40550,39579,854.29106767),
//                   array(1621441800000,37505,39714,40205,37486,1825.82192756),
//                   array(1621440000000,37481,37505,37691,36254,1785.48998402),
//                   array(1621438200000,36944.01228092,37480,37999,36755,1035.93083771),
//                   array(1621436400000,37607.27434975,36944,37967,36648,2010.36666197),
//                   array(1621434600000,35786.78497009,37597,37726,34864,2379.65442334),
//                   array(1621432800000,36066,35765,36094,34406,1946.86695743),
//                   array(1621431000000,33514,36064,37200,33155,3592.69278767),
//                   array(1621429200000,34573.89580974,33514.42142362,34999,29563,7518.90671132),
//                   array(1621427400000,38428,34549,38428,32089,5682.69384421),
//                   array(1621425600000,38787.25026689,38452.66082496,39244,38333,799.50220507),
//                   array(1621423800000,38333,38800,39000,36567,3752.70675087),
//                   array(1621422000000,39460.97522979,38333,39581.74266859,38200,4701.85701626),
//                   array(1621420200000,39662,39460.97522979,39680,38948,575.83939631),
//                   array(1621418400000,40383.4979663,39663,40478.33770231,39500,354.51158189),
//                   array(1621416600000,40216,40410,40496.08775923,40108,201.45358612),
//                   array(1621414800000,40573.05750719,40222,40800,40128,215.02933972),
//                   array(1621413000000,40449.41871242,40561,40900,40271,274.3289005),
//                   array(1621411200000,40561.58851303,40449,40622,39985,1092.57159191),
//                   array(1621409400000,39668,40576,40656,39511,1322.03520462),
//                   array(1621407600000,39471.953709,39669,39732.58552071,38674.54028088,1517.23841929),
//                   array(1621405800000,39831,39465.52968547,39831,39193,1267.41339008),
//                   array(1621404000000,39252,39834,39909,39252,937.42982322),
//                   array(1621402200000,39689,39252,39703.38687557,39037,631.40783786),
//                   array(1621400400000,39293,39689,39814,39166,2237.91657036),
//                   array(1621398600000,39622,39292,40192,38651,1351.04102485),
//                   array(1621396800000,40671.06476555,39622,40961,39500,1116.4597083200001),
//                   array(1621395000000,41053,40658,41056,40551,852.25570683),
//                   array(1621393200000,40379,41052,41102.6557868,40227,953.41669762),
//                   array(1621391400000,40947,40356.6837319,41199.91489965,40333,1405.94432843),
//                   array(1621389600000,40905,40947,41367,40661,930.66296507),
//                   array(1621387800000,41519,40907,41720.46367106,40572,1612.0742255),
//                   array(1621386000000,42612.03121728,41513.77030245,42713,41352,1092.41639917),
//                   array(1621384200000,43225,42596,43233,42594.2753294,234.82812195),
//                   array(1621382400000,42898.48904022,43249,43600,42566,831.39047261),
//                   array(1621380600000,42887,42900,43217,42475,334.33210655),
//                   array(1621378800000,42836.41651521,42894,42898,42316,378.27230139),
//                   array(1621377000000,43154,42861.80523037,43299,42804,120.0105628),
//                   array(1621375200000,43032,43134,43196,42761,109.63491578),
//                   array(1621373400000,43286,43032,43286,42837,115.03812116),
//                   array(1621371600000,43321.21579566,43284,43544.32731838,43007,137.96251559),
//                   array(1621369800000,43474.64742771,43292,43641,43183,416.87134542),
//                   array(1621368000000,43285,43443,43548,42777,203.88936362),
//                   array(1621366200000,42786,43282,43632.59312154,42734,201.11939685),
//                   array(1621364400000,42842.38247624,42771,43069.84878225,42551.89068566,161.96882283),
//                   array(1621362600000,42946.76185475,42877.28536909,43060,42444,186.65081337),
//                   array(1621360800000,43400.20295059,42942,43400.20295059,42736,274.58125608),
//                   array(1621359000000,43844,43401,43859,43343,112.58805462),
//                   array(1621357200000,43650,43825,43891,43353,199.54336124),
//                   array(1621355400000,43419.72734108,43667.50346631,43725.50639243,43134.4448386,217.77210034),
//                   array(1621353600000,43037,43419.72734108,43512,42712.25243673,214.71034504),
//                   array(1621351800000,43722,43037,43722,42855,322.77848088),
//                   array(1621350000000,43264,43736,43840,42911,320.13505519),
//                   array(1621348200000,43314.86313526,43281.6519107,43383,42680,452.83185251),
//                   array(1621346400000,43752.2194287,43320.60797866,43756.22300818,42927,391.90900708),
//                   array(1621344600000,43670,43753.77961846,44011,43644.12299211,346.38396138),
//                   array(1621342800000,44010,43670.69106631,44120,43368,522.96945038),
//                   array(1621341000000,44729.7009306,44017,44883.40433436,43788,572.83650944),
//                   array(1621339200000,45365,44729.77472557,45376,44729.77472557,200.91845792),
//                   array(1621337400000,45580.72497479,45351,45667,45350,153.9776544),
//                   array(1621335600000,45396,45576.13828132,45613,45173.98062348,252.92999083),
//                   array(1621333800000,45199,45395,45444,45184,117.83867812),
//                   array(1621332000000,44948,45189,45370,44722,168.5916413),
//                   array(1621330200000,44847,44964.67686695,45131,44755,92.49034271000001),
//                   array(1621328400000,44944,44847.49262357,45010,44620,184.31093856),
//                   array(1621326600000,45262,44905,45281,44811,105.92850573),
//                   array(1621324800000,45131.19781905,45261,45356,44966.25456143,133.35455478),
//                   array(1621323000000,44971,45106,45176,44833,205.33730271),
//                   array(1621321200000,44844.12616182,44976,45130,44777.15161259,285.09644229),
//                   array(1621319400000,45459.0589023,44850,45491,44781.35020858,255.27653584),
//                   array(1621317600000,45367,45460,45800,45312.18981923,276.14344774),
//                   array(1621315800000,45286.44957001,45365.45305229,45452,45100,135.15420385),
//                   array(1621314000000,45334,45293,45522.62598924,45223,120.35536187),
//                   array(1621312200000,45091,45332.84196651,45570,45033,172.68618529),
//                   array(1621310400000,44800,45076.90641907,45398.63117871,44774.99947008,205.77905528),
//                   array(1621308600000,44958,44813,45061,44705,63.12971552),
//                   array(1621306800000,45060,44954,45066,44724,81.08540785),
//                   array(1621305000000,44694,45060,45193,44680.72435419,98.28547316),
//                   array(1621303200000,45081.85688682,44681,45222,44555,132.73391094),
//                   array(1621301400000,45095,45081.54425896,45199,44802.43395441,108.55743926),
//                   array(1621299600000,44389,45088.71047676,45244,44335,251.0308211),
//                   array(1621297800000,44458,44379,44601,44137,171.37397935),
//                   array(1621296000000,43540,44458,44600,43183,435.09901159),
//                   array(1621294200000,43251,43534,43755,43113,326.31340975),
//                   array(1621292400000,42892,43251,43437,42470,413.55885198),
//                   array(1621290600000,43484,42898,43633,42628,416.91273632),
//                   array(1621288800000,43525,43484,44381.663442,43472,420.97862885),
//                   array(1621287000000,44423,43525.86615465,44423.69015283,43301,234.20765534),
//                   array(1621285200000,44762,44529,44795,44423,170.5059516),
//                   array(1621283400000,44299,44761,44900,44254.2647572,287.12365363),
//                   array(1621281600000,44199,44299,44451,44053.99099207,347.34231657),
//                   array(1621279800000,44102,44177,44267,43881.23011665,483.31666465),
//                   array(1621278000000,43259,44091,44348,43259,704.31485664),
//                   array(1621276200000,42722.79063547,43259,43647,42522,2051.64064056),
//                   array(1621274400000,42481.16661102,42713.70996253,43466,42168,4417.65453805),
//                   array(1621272600000,42438,42446,43098,42435,2534.90893136),
//                   array(1621270800000,42464,42422,42839,42128,1592.24692792),
//                   array(1621269000000,43511.49892253,42477.80080592,43519.79581295,42434,2556.24827699),
//                   array(1621267200000,43380,43499.13402814,43866,42862,2434.59654401),
//                   array(1621265400000,44111,43394,44191.95018626,43209,1309.02790639),
//                   array(1621263600000,44565.04234728,44085,44691,43961,225.64049516),
//                   array(1621261800000,44264,44520,44573,43911,201.83699177),
//                   array(1621260000000,45162,44221.7682878,45245,44093,745.49703699),
//                   array(1621258200000,44680.24876897,45158,45348,44672.95919173,362.29970488),
//                   array(1621256400000,45067,44668,45176,44668,186.47926119),
//                   array(1621254600000,45231.67287607,45053,45384,44874.58529679,273.95270791),
//                   array(1621252800000,45875.5400536,45228,45911,45228,146.2181071),
//                   array(1621251000000,45239,45852.32949029,45894,45239,306.95341252),
//                   array(1621249200000,44691.04274397,45234.4211235,45443,44531,224.08646944),
//                   array(1621247400000,45150,44690,45318.65339826,44626.1402036,369.90316973),
//                   array(1621245600000,45582.09626357,45137,45642,45137,153.14175206),
//                   array(1621243800000,45266,45578.45037644,45637,45148,249.60386522),
//                   array(1621242000000,45508,45284,45641,45129,182.12793912),
//                   array(1621240200000,45355,45512,45689,45306.67737413,277.11807956),
//                   array(1621238400000,45342,45355,45672,44941.43005065,684.75886624),
//                   array(1621236600000,44868.26612775,45328,45437.05545251,44808,568.90348001),
//                   array(1621234800000,44459.49473357,44883,45007,44290,386.99645294),
//                   array(1621233000000,44960.43183212,44452,44964,44211,698.41966016),
//                   array(1621231200000,44304.15825253,44950.5662159,45445.57581498,44068,1186.33046586),
//                   array(1621229400000,43190,44303,44427,42650,810.64076274),
//                   array(1621227600000,43816,43190,44021.21470379,43115,247.73392064),
//                   array(1621225800000,43849,43815.02999251,44055,43189.24381819,285.47163851),
//                   array(1621224000000,43136,43849,44623,42321,2238.9503712),
//                   array(1621222200000,43491,43116,44142,43061,1013.87394109),
//                   array(1621220400000,44600,43490,44837,43490,1189.41074915),
//                   array(1621218600000,44990,44641,44990,44412,390.82937672),
//                   array(1621216800000,45017.99790083,45001,45382,44837,151.55779195),
//                   array(1621215000000,45213,45019,45379,44716,246.83441755),
//                   array(1621213200000,45757,45174,45804.63412916,44935,443.73443282),
//                   array(1621211400000,46215.43735448,45757,46657,45711,1302.12836909),
//                   array(1621209600000,46587.61320955,46214,46796,46144,1271.84059315),
//                   array(1621207800000,46084,46597,46677,45801,340.29739084),
//                   array(1621206000000,45657,46063,46277,45500,289.13437836),
//                   array(1621204200000,46005,45637,46005,45632,266.16106725),
//                   array(1621202400000,45325,46005,46337,45325,479.5869646),
//                   array(1621200600000,44687,45278,45727.61943702,44384,662.70626925),
//                   array(1621198800000,44249,44678,44936.11338736,44022,570.20960562),
//                   array(1621197000000,44866.86759817,44247.88434072,45348,44021,1585.10570295),
//                   array(1621195200000,45639,44854,46024,44816,768.7599467),
//                   array(1621193400000,45848.59555201,45651.52306865,46237,44655,1188.6166664),
//                   array(1621191600000,45492,45807.22920149,46037,45136,706.43824756),
//                   array(1621189800000,46314.75131874,45505.82649116,46886,45440,2883.99193788),
//                   array(1621188000000,47117,46318,47255,46266,476.2171395),
//                   array(1621186200000,47052.00753532,47106,47303.42769484,46677,734.20584844),
//                   array(1621184400000,47287,47053.22212546,47366,46277,1555.36405448),
//                   array(1621182600000,47697,47287,47704,47000,905.93274534),
//                   array(1621180800000,47805.2396598,47705,48151,47417,276.37538221),
//                   array(1621179000000,47970,47805,48240.32035194,47746,114.43222986),
//                   array(1621177200000,48372,47970,48388,47848,280.38109309),
//                   array(1621175400000,48419.63603592,48373,48588.78223039,48063,138.8447522),
//                   array(1621173600000,49003,48426.03943276,49264.99077519,48358,491.81687878),
//                   array(1621171800000,48678,49003,49053,48641,67.14350562),array(1621170000000,48701,48679,48833,48545,122.90449434),
//                   array(1621168200000,49103,48701,49156.55345132,48625,246.37535709),array(1621166400000,49122.72489226,49105,49266,49017.21438609,58.109751010000004),
//                   array(1621164600000,49403,49121,49455,49010,57.84886987),array(1621162800000,49677,49407,49724,49401,28.66176947),array(1621161000000,49545,49650,49870,49386,106.94206301),
//                   array(1621159200000,49358.45012831,49545,49545,49321,62.07748086),array(1621157400000,49219,49357.04012859,49563.77995027,49209,53.40082797),
//                   array(1621155600000,49032,49213,49300.21388932,48989,44.90471415),array(1621153800000,48987,49032,49117.34017653,48775,75.4318827),
//                   array(1621152000000,49491,48992,49500,48935,67.96781636),array(1621150200000,49044,49491,49492,48981.01065837,101.82662133),
//                   array(1621148400000,49171,49044,49244.34274276,49020.85815652,63.31513147),array(1621146600000,49259,49166,49402,49151,77.24201158),
//                   array(1621144800000,48311.75376027,49248,49588,48302,310.6987789),array(1621143000000,48316,48308,48486,48242.30587509,41.07222231),
//                   array(1621141200000,48265,48333,48484,48193.79036124,90.41440888),array(1621139400000,48520,48250,48526,48215,70.98914531),
//                   array(1621137600000,48555,48512,49033,48500,661.26141562),array(1621135800000,47913,48555,48556,47910,446.6890394),
//                   array(1621134000000,48270.61091818,47906.15041877,48423,47857.35392645,87.51165147),array(1621132200000,48276.31439909,48251.4109252,48423.27980635,48135,64.67853959),
//                   array(1621130400000,48176,48276,48333,48069,62.05043845),array(1621128600000,48011.90039762,48165,48337,47786,557.63963854),
//                   array(1621126800000,47390,48016,48210,47386,114.16414096),array(1621125000000,47574,47353,47757,47022.61137459,181.8387028),
//                   array(1621123200000,46844,47587,47815,46500,430.99435615),array(1621121400000,47534.19982194,46844,47617,46644,342.31108461),
//                   array(1621119600000,48052.79038944,47512,48119,47411,137.65756402),array(1621117800000,48506,48078.79435079,48561,47837,130.63982989),
//                   array(1621116000000,48508.22029836,48506,48739,48413,56.57915104),array(1621114200000,48498,48507,48833,48379.55456121,83.01579255),
//                   array(1621112400000,48304,48499,48692,48303,77.84445419),array(1621110600000,48502,48297,48582,48200,99.67162781),
//                   array(1621108800000,48184,48502,48670,48134.2073524,162.82914974),array(1621107000000,47239,48157,48189,46984,530.14149378),
//                   array(1621105200000,47957,47239,48089,47138,452.33542979),array(1621103400000,48099.32038014,47957.01103286,48159,47861,59.68226281),
//                   array(1621101600000,47854,48106.03954979,48253,47581,199.01146473),array(1621099800000,47792,47869.4904261,48272,47792,158.70551679),
//                   array(1621098000000,47989,47793,48017.60669871,47487,612.45434471),array(1621096200000,47883.08442933,47942.81041144,48125.7052214,47594,617.1150289),
//                   array(1621094400000,49062,47899,49067.9901864,47871,992.51625241),array(1621092600000,49337,49049.66019007,49367,48937,171.79308281),
//                   array(1621090800000,49507,49326,49658.78006824,49237,86.78260293),array(1621089000000,49005,49509,49649,48927,220.41788798),
//                   array(1621087200000,49086,49013.0001974,49566,49000,196.42264055),array(1621085400000,49137,49088,49413,48823,86.52773651),
//                   array(1621083600000,49258,49136,49414,49015.82019684,63.97070276),array(1621081800000,48959,49260,49371,48952,117.17179204),
//                   array(1621080000000,49028,48936,49078,48759,64.34927529),array(1621078200000,48778,49058.72491567,49094,48550,75.95195465),
//                   array(1621076400000,48498,48799,48935.45021291,48440.03462639,88.5492093),array(1621074600000,48030,48461,48580,47938.65833944,199.67186244),
//                   array(1621072800000,48683,48030,48683,47968,330.97356716),array(1621071000000,48556,48725.010752,48831.06785607,48426.03943276,78.57970805),
//                   array(1621069200000,48913,48550,49318,48516,113.07915099),array(1621067400000,48720,48881,49100,48419,125.22755262),
//                   array(1621065600000,48531.38533021,48680,48787,48242,204.95041685),array(1621063800000,48885,48538.70136747,49011,48455,202.72679837),
//                   array(1621062000000,49035,48885,49135,48422.38229124,604.69930836),array(1621060200000,49542,49052,49700,48705,273.55928573),
//                   array(1621058400000,49761,49550.21008996,49765,49000,327.33412477),array(1621056600000,49496,49770.17004597,49809,49323,54.6278848),
//                   array(1621054800000,49411,49507,49667,49212,105.23379137),array(1621053000000,49853.67421508,49411,49939,49263,103.44103256),
//                   array(1621051200000,49713,49854,49884,49643.63045832,50.71723259),array(1621049400000,49894,49725,50021.46742072,49713,56.70122279),
//                   array(1621047600000,50138.17997236,49874,50138.17997236,49829,74.89381904),
//                   array(1621045800000,50394.79992104,50163.18165461,50463,50111,42.22002964),
//                   array(1621044000000,50714,50365,50715,50354,66.6779618),
//                   array(1621042200000,50409,50711,50737,50289,78.11582161),
//                   array(1621040400000,49530,50409,50581,49461,193.75835681),array(1621038600000,49668,49529.77142628,49907.50896064,49371.87470774,98.72595781),
//                   array(1621036800000,49923.30794743,49660,50388,49438.82011224,218.26809381),array(1621035000000,50045.95342119,49924,50182.38164759,49906.30575051,56.90792826),
//                   array(1621033200000,49998,50045.95342119,50224,49833.62003328,63.36683048),array(1621031400000,49935,49998,50241,49822.50920851,256.54972352),
//                   array(1621029600000,49896,49935,49952,49726,69.37863248),array(1621027800000,49771,49899.62824626,49940.78001184,49609,57.76220183),
//                   array(1621026000000,49249,49782,49899,49115.62246479,235.18127864),array(1621024200000,49830,49249.76940458,49830.15011629,49187.28413336,247.06741042),
//                   array(1621022400000,50209,49828.98376745,50353.23628853,49768,118.74429718),array(1621020600000,50290,50203,50441,50188,112.29673566),
//                   array(1621018800000,50531,50268,50531,50195,139.07320614),array(1621017000000,50447.10338924,50520,50680,50407,192.33830469),
//                   array(1621015200000,50666,50418,50759.35979694,50403,138.37904209),array(1621013400000,50815.8225275,50666,50879,50609.25788571,100.56373482),
//                   array(1621011600000,50881,50816,51085,50811,60.86807958),array(1621009800000,51073.37282183,50884.83288866,51220.38891747,50767,115.09538806),
//                   array(1621008000000,51274,51079.77276472,51365,51011,60.83542425),array(1621006200000,51406,51265,51452,51111,68.25632965),
//                   array(1621004400000,50972,51403,51512,50972,319.50994916999997),array(1621002600000,50692,50948,50996,50569,92.58172818),array(1621000800000,51007,50691.26102769,51012,50669,226.05868436),
//                   array(1620999000000,50449.89184276,51007,51024,50431,200.4204509),array(1620997200000,50418,50449.42251786,50518,50137,107.15392195),array(1620995400000,50417,50418,50601.75220541,50294,98.97152444),
//                   array(1620993600000,50641,50414,50715,50335,83.15357699),array(1620991800000,50730,50618,50794,50572,71.52918057),array(1620990000000,50794.94668684,50725,51022,50638,164.16649632),
//                   array(1620988200000,50454,50789.8831978,50817,50389,78.31994432),array(1620986400000,50510.56540503,50454,50589,50325,72.60890826),array(1620984600000,50689.99053066,50509,50885,50509,83.24050569),
//                   array(1620982800000,50448,50689,50824.54684746,50288.87366551,124.81804389),array(1620981000000,50250,50448,50500,50177,65.92264874),array(1620979200000,50065,50253,50468,49990.85730361,132.64340125),
//                   array(1620977400000,49999,50061,50313,49914,81.44412162),array(1620975600000,49123,50010,50165,49107,282.68888868),array(1620973800000,49045,49116,49245,48929,90.66146414),
//                   array(1620972000000,49679.83221127,49026,49745.28692988,49002,88.59618603),array(1620970200000,49362,49712,49759.84290006,49182,95.61883982),array(1620968400000,49224.35163662,49381,49514,49102,92.08563104),
//                   array(1620966600000,49327,49224,49521,48877,196.95653271),array(1620964800000,49219,49363,49563,49219,93.65110237),array(1620963000000,49611,49224,49611,49048.1131389,81.46411543),
//                   array(1620961200000,49510.44042815,49612,49689,49314.17492616,41.70472531),array(1620959400000,49529.68966163,49511,49775,49511,94.94997407),array(1620957600000,50087,49521.7242559,50131,49407,335.71678717),
//                   array(1620955800000,50221,50085,50331,50018,47.2437802),array(1620954000000,50095.80391393,50239,50450,49943,146.61076782),array(1620952200000,49821,50071,50287,49812,77.32636339),
//                   array(1620950400000,49749,49829.31990547,50223,49565,187.38283055),array(1620948600000,49193.84866133,49750.64971553,49810,49058,119.2937634),array(1620946800000,48924,49200,49405,48488,180.7161134),
//                   array(1620945000000,49414,48915,49912,48915,152.9979978),array(1620943200000,49620,49421.84755883,49639,49075,101.377632),array(1620941400000,49711,49625,49905,49443,125.79934572),
//                   array(1620939600000,49327.34795956,49726,49851,49072,150.66600023),array(1620937800000,49153,49344.20816737,49492,49112,130.4386306),array(1620936000000,48633,49129,49469,48438,189.3050966),
//                   array(1620934200000,48988,48613.99712298,49429,48592,209.05127112),array(1620932400000,47912.9295089,48923,49136.75075653,47912,373.76724061),array(1620930600000,48477,47913,48728,47760,275.41000185),
//                   array(1620928800000,48509,48477,48989,48189,224.64817987),array(1620927000000,47600,48510,48536,47100,812.15675027),array(1620925200000,48711,47598,48923.23736092,47463,940.12895545),
//                   array(1620923400000,50364.13386655,48722,50364.13386655,48564,1171.97147469),array(1620921600000,49716,50383,50457,49695,101.95901399),array(1620919800000,50021,49731,50257.94520221,49616,310.89304434),
//                   array(1620918000000,50384,49995,50426.56691186,49926,120.89778641),array(1620916200000,50596,50369,50680,50264,113.44403984),array(1620914400000,50538,50591,50900,50435,376.0121015),
//                   array(1620912600000,50039,50537,50599,50039,202.48342846),array(1620910800000,50202,50036,50458.33266963,49730,429.59982955),array(1620909000000,50235,50188.43621504,50329,49999,105.62375443),
//                   array(1620907200000,49799,50277,50381,49600,215.89400147),array(1620905400000,49449,49788,49917,49432.7470199,137.24750989),array(1620903600000,49218.49721376,49450,49468,48530,359.12063544),
//                   array(1620901800000,49752,49256,49759,48977,464.44490502),array(1620900000000,49273,49765,50288,49272,400.07226962),array(1620898200000,49817,49253,50119,48842,877.79792589),
//                   array(1620896400000,50079.25458501,49836,50422,49785,336.9275463),array(1620894600000,50511,50070,50678,50008,223.22480866),array(1620892800000,50908.5034802,50519,50935.26571216,50264,314.55544825),
//                   array(1620891000000,50967,50908,50991.23164484,50708,84.22488165),array(1620889200000,51300,50958,51333,50958,266.40349905),array(1620887400000,50892,51300,51313,50819,462.83320851),
//                   array(1620885600000,50937.59599343,50888,51255,50855.65293171,396.46900704),array(1620883800000,51090,50937.59599343,51103,50837,315.31310005),array(1620882000000,50505.94547462,51090,51092,50499,249.37975597),
//                   array(1620880200000,50982.57036188,50522,50982.57036188,50315,360.82160368),array(1620878400000,50481,50991.0074598,51008,50437,420.52398666),
//                   array(1620876600000,49850.48637684,50482,50501,49585.4093064,366.84863665),array(1620874800000,50312,49851,50312,49608,543.11301082),array(1620873000000,50428.67893741,50313,50585,50066,466.57663958),array(1620871200000,50517.00381221,50437,50879,50272,626.50365032),
//                   array(1620869400000,50331.19944707,50517,50517,49698,427.6351088),array(1620867600000,49695,50331,50586,49429,564.17395386),array(1620865800000,49666.84472434,49695,50444,49619,915.72058187),
//                   array(1620864000000,49580.54694147,49641,49688,46601.04807999,4450.07072897),array(1620862200000,51635,49614,52115,48611,1925.24362028),array(1620860400000,52882,51613.02008803,52882,51402.90180593,903.19450135),
//                   array(1620858600000,52745,52866,52977,51653.02979982,1034.17676934),array(1620856800000,54544,52740,54748,52218,2053.24073833),array(1620855000000,54719.54407423,54543.87857073,54729,54360,132.0180893),
//                   array(1620853200000,54445,54719,54740.25515495,54360,107.33659241),array(1620851400000,54055,54444,54670,54053,125.51169592000001),array(1620849600000,54489,54056,54494,54055,81.90016945),
//                   array(1620847800000,54150,54495,54530,53929,202.81546707),array(1620846000000,54099.73517359,54149,54279,53533,280.11264199),array(1620844200000,54381,54138,54407,53546,869.85900513),
//                   array(1620842400000,54878,54387.2748009,55132.68725659,54082,594.18620948),array(1620840600000,55038,54879.8232215,55190.96869282,54811,96.16295783),
//                   array(1620838800000,54965,55039,55271.30519798,54729,173.8161044),array(1620837000000,55108,54981,55190,54381.52884308,490.71273289),array(1620835200000,55471,55111,55688.82155167,54712,737.85675792),
//                   array(1620833400000,55626.46027156,55471,55815,55330,348.97319861),array(1620831600000,56096.63340517,55622,56163,55417,341.37161395),array(1620829800000,56765,56082.14563828,56824,56056,164.54221989),
//                   array(1620828000000,56766.58872411,56766,56934.73017332,56534,153.89059294),array(1620826200000,55889.78445012,56766,56873.39205182,55795.3388569,262.35542547),
//                   array(1620824400000,56333,55892,56405.58922927,55822,257.71904829),array(1620822600000,56629,56342,56636,56197.80738089,315.15197421),array(1620820800000,56419.968654,56635,56635,56255,127.46832001),
//                   array(1620819000000,56202,56443.62854806,56499,56202,43.8958205),array(1620817200000,56070.4262495,56218,56372,56047,86.95583968),array(1620815400000,56393,56061,56438,56011,227.43886326),
//                   array(1620813600000,56864,56400,56864,56254,501.64236193),array(1620811800000,56898.17202857,56862,57195.9606792,56861,160.280044),array(1620810000000,56950,56898,56950.59959924,56800,47.04584791),
//                   array(1620808200000,56673,56950.59959924,56954,56637,210.73627565),array(1620806400000,57138,56677.79410812,57197,56673,202.86213712),array(1620804600000,57266,57150,57266,56931,73.63416905),
//                   array(1620802800000,57066,57266,57279,57053,25.92629837),array(1620801000000,57144,57062,57260.23190045,57009,38.25026936),array(1620799200000,57287,57141,57411.32534736,57073,103.65780787),
//                   array(1620797400000,57462,57291,57482,57232,94.96610131),array(1620795600000,57415,57462,57540.78354625,57308,52.41001211),array(1620793800000,57749,57386,57749,57361,110.98617149),
//                   array(1620792000000,57824.035748,57748,58000,57720,241.72411562),array(1620790200000,57289.6596018,57824,57888,57202,353.89083241),array(1620788400000,57186.713316,57289,57303,57039.023195,49.38496866),
//                   array(1620786600000,57274.07856016,57187,57320,56997.5908905,50.21041678),array(1620784800000,57065,57291,57364,56967,37.14751336),array(1620783000000,57106,57062,57166,56963,48.96677994),
//                   array(1620781200000,57359,57110,57359,57099,76.46434151),array(1620779400000,57019,57359,57359,56981,133.07060768),array(1620777600000,56717,57028,57234,56593,222.87920843),
//                   array(1620775800000,56361,56721.504604,56795,56272,63.35904456),array(1620774000000,56435,56361,56614,56311,44.10128191),array(1620772200000,56567,56434.43936365,56645,56356.0593948,30.97093758),
//                   array(1620770400000,56539,56569,56639,56377,44.88143528),array(1620768600000,56611,56538,56793,56386,82.73680088),array(1620766800000,56849,56611,56870,56611,56.01386322),
//                   array(1620765000000,56772,56849,56870,56697,58.24529614),array(1620763200000,56634.04245912,56768.71046,56825,56536,53.64522009),array(1620761400000,56764,56634.04245912,56849,56573,82.59959665),
//                   array(1620759600000,56391,56764,56777,56377.45354712,62.73666028),array(1620757800000,56680,56388,56680,56248,206.79774903),array(1620756000000,56407,56680,56680,56378,132.53361308),
//                   array(1620754200000,56415.431648,56406.145392,56499,56288.72140759,84.53164242),array(1620752400000,56003,56420,56450,55930.0432914,66.09353554),array(1620750600000,56245,55999.707316,56247,55748,291.91491603),
//                   array(1620748800000,56075,56226,56598,55870,281.34464819),array(1620747000000,56112,56079,56179,55884.5602402,103.77368423),array(1620745200000,55711,56118,56137,55589,133.66012938),
//                   array(1620743400000,55819,55711.754186,55842,55550,131.05054449),array(1620741600000,55730.98199043,55820,55891,55484,135.25186284),array(1620739800000,54990,55722.49740765,55742,54878,110.16337856),
//                   array(1620738000000,55339,54991,55867.18698148,54939.8071382,420.49926419),array(1620736200000,54915,55339,55358,54730,183.34466396),array(1620734400000,55174,54911.8950064,55284,54799,188.65430046),
//                   array(1620732600000,55910,55191.55401,55910,55108,178.52707382),array(1620730800000,55820,55914,55922,55518,97.79822381),array(1620729000000,56063,55807,56091.16531328,55720,50.19565708),
//                   array(1620727200000,55907.705793,56061,56150,55861,140.7810288),array(1620725400000,55478,55931,55990.66932045,55461,158.86079609),array(1620723600000,55263,55492.89777048,55725,55250,157.53829922),
//                   array(1620721800000,55297.33985439,55250,55548,55117.8877011,63.79794594),array(1620720000000,55701,55284,55789,55222,76.39376355),array(1620718200000,55438,55700,55725.17135792,55376,33.83398664),
//                   array(1620716400000,55687,55446,55770,55399,170.26507707),array(1620714600000,55164,55687,55738,55164,169.59977184),array(1620712800000,54792,55173,55208,54739,44.84145729),
//                   array(1620711000000,55051.21159192,54769.26655098,55090,54600,134.93932178),array(1620709200000,55309.74094219,55039,55455,54945,97.64388131),array(1620707400000,55455,55302,55455,55061,16.66993381),
//                   array(1620705600000,55125,55455.25181889,55500,54978,123.49023545),array(1620703800000,54778,55140,55225.88322313,54711,101.21795518),array(1620702000000,54556,54818,54860,54138.73738416,830.36105798),
//                   array(1620700200000,55785,54556,55820.02374614,54500,1034.52774801),array(1620698400000,55610.91660171,55784,55925,55209.61649091,117.77165237),
//                   array(1620696600000,55338.650448,55589,55724,55252.03061482,71.02867209),array(1620694800000,55528,55338.650448,55860,55131.648224,187.68684805),
//                   array(1620693000000,56377,55521.033995,56419.055256,55521.033995,192.39823071),array(1620691200000,55831,56376,56602,55505,389.78698641),
//                   array(1620689400000,55704,55829.62510011,56174,55528.31137366,142.10354158),array(1620687600000,56239,55710,56239.31642021,55634,79.56270154),array(1620685800000,55788,56239,56250,55454,137.35341407),
//                   array(1620684000000,55661,55797.476637,56015,55574,177.56349748),array(1620682200000,55387,55666,55789,55383,140.14982356),array(1620680400000,55283,55387,55690,55087,259.04107045),
//                   array(1620678600000,55112,55287,55536,54661,434.66848514000003),array(1620676800000,55770.00541035,55132,55770.00541035,53844,2531.20032058),array(1620675000000,56481.541572,55771,56700,55566,825.86014671),
//                   array(1620673200000,56770,56500.6890777,56997,56478,178.81295975),array(1620671400000,56704.26038161,56770,57030,56408,254.69723848),array(1620669600000,56988.2484375,56699.328132,57228,56317,831.5305082900001),
//                   array(1620667800000,57411,56989,57639,56872,362.47301718),array(1620666000000,57708,57458.793258,57739,57410.65058841,272.25992921),array(1620664200000,58152,57708,58164.87429403,57708,108.00289876),
//                   array(1620662400000,58371.28386936,58113,58638,58113,215.25380124),array(1620660600000,57413.04857688,58384,58412,57278,276.65669439),array(1620658800000,57010,57417,57473,56637,520.65167743),
//                   array(1620657000000,57381,57010,57579,57010,563.0450609),array(1620655200000,57778,57381,57778,57255,361.19550645),array(1620653400000,57668,57808.76710784,57955,57543,151.81742969),
//                   array(1620651600000,57715,57671,58012,57525,86.72841193),array(1620649800000,57826.35436136,57712.28774444,58258,57577,145.77305389),array(1620648000000,58159,57828,58269,57676.57443852,199.95869031),
//                   array(1620646200000,57800,58176,58389,57785,80.30730839),array(1620644400000,57902,57800,57902,57392,122.52180291),array(1620642600000,58205,57900,58205,57614,142.06252417),
//                   array(1620640800000,57938,58209.62843121,58210,57727,108.52246791),array(1620639000000,58206,57930,58216,57752,403.50301777),array(1620637200000,58448,58206,58636.553253,58204,98.72546371),
//                   array(1620635400000,58315,58448,58516.35820701,58315,54.69523098),array(1620633600000,58438,58316,58664,58083,290.18315173),array(1620631800000,58889,58438.158574,58914,58437,172.89205916),
//                   array(1620630000000,58897,58889,59015.31668496,58741,65.54501466),array(1620628200000,59002,58918,59037.98160393,58825,56.2385378),array(1620626400000,59113,59025,59227,58991,65.07395524),
//                   array(1620624600000,58978,59109,59140.761474,58732,140.27163759),array(1620622800000,59261.24133661,58978.376985,59500,58860,113.38461818),array(1620621000000,59266,59276,59443.3243668,59193.533639,79.62541773),
//                   array(1620619200000,59455,59275,59589.77113765,59150,496.31653292),array(1620617400000,59394,59450,59474,59278,325.16232903),array(1620615600000,59052,59394,59395,58998,461.36746592),
//                   array(1620613800000,58749,59034,59099,58746.0549207,108.71590199),array(1620612000000,58759.74117234,58748,58992,58699,95.96052324),array(1620610200000,58750,58760,58995,58679,46.61741266),
//                   array(1620608400000,58888,58750,58999,58705.85649,159.91321139000001),
//                   array(1620606600000,58187.9435767,58888,58888,58172,439.51561668),
//                   array(1620604800000,58286.86932662,58187,58421.39804157,58080,106.07096251),
//                   array(1620603000000,58307,58276,58444,58203,167.96820789),array(1620601200000,57973.90572456,58302,58350,57973.90572456,105.03714028),array(1620599400000,58175.67264993,57973,58236.714696,57895,66.22003451),
//                   array(1620597600000,58026,58176,58223.1174938,57979,70.49810066),array(1620595800000,57839,58026,58149.29629558,57836,78.35951913),array(1620594000000,57885,57839,58015,57779,222.11465367),
//                   array(1620592200000,57659.15766023,57885.9933598,57910,57610.18606378,91.17707476),array(1620590400000,57281,57668,57888.32781245,57217,152.30804419),
//                   array(1620588600000,57158,57281,57440.57776737,57150,43.25707707),array(1620586800000,57456,57151.60447758,57558,57150,174.56970284),array(1620585000000,57513.46084276,57487,57555,57239,42.42226536),
//                   array(1620583200000,57462,57534,57630,57337,102.10971632),array(1620581400000,57430,57462,57502,57305,118.78866475),array(1620579600000,57586,57429,57643,57357,74.82943532),
//                   array(1620577800000,57614,57611,57714,57460,61.8981998),array(1620576000000,57300,57614,57844.05297,57254,402.38042923),array(1620574200000,57299,57300,57300,57172,241.85029433),
//                   array(1620572400000,57135,57299,57300,56977,260.91974294),array(1620570600000,57290,57137,57370,57128.33052504,194.53006528),array(1620568800000,57190.36307607,57290.10168753,57400,57167,146.01519557),
//                   array(1620567000000,56765,57193,57251,56722,357.80450662),array(1620565200000,56353.055967,56767,56935,56343.846597,548.97066701),array(1620563400000,56830.33101519,56343,57170,56255,771.26996762),
//                   array(1620561600000,57933.39487649,56831,57999.77351584,56650,919.92151393),array(1620559800000,58042,57933.5373639,58225.4552511,57933.5373639,42.30242674),
//                   array(1620558000000,57986,58030.8433263,58110,57911,38.41664707),array(1620556200000,57807.03961278,57978,58036.92494895,57775,53.25730578),array(1620554400000,57974,57807,57974,57571,49.37026507),
//                   array(1620552600000,58184.23694356,57974,58207,57632,84.05434273),array(1620550800000,58180,58183,58381.14479094,57935,62.80017861),array(1620549000000,58132,58207,58231.53687375,58056,88.22753014),
//                   array(1620547200000,57992,58132,58143,57858,44.48320427),array(1620545400000,58075,57983.00411332,58079,57774,113.71756656),array(1620543600000,58372,58074,58372,57983,55.43309532),
//                   array(1620541800000,58533,58373,58571,58271,56.08367392),array(1620540000000,58502,58533,58603,58441,71.94824299),array(1620538200000,58422.49982496,58502,58589,58237,104.90207924),
//                   array(1620536400000,58117,58422.49982496,58422.49982496,57942.05163561,66.71759496),array(1620534600000,58416,58127,58472,57918,416.60182429),array(1620532800000,58636,58415,58853,57850,577.89503461),
//                   array(1620531000000,58922.09065444,58636,58982,58483,203.06338602),array(1620529200000,58606.16482899,58922,59001.47030124,58571,56.41871685),array(1620527400000,58769,58607,58799,58522,86.64772896),
//                   array(1620525600000,59125,58778,59140,58753,79.46176623),array(1620523800000,58443.59407152,59117,59236.51695169,58399,382.10714249),array(1620522000000,58539.1892969,58444,58659,58404.25495701,77.79402856),
//                   array(1620520200000,58971.00141179,58538,59000,58537,80.34062269),array(1620518400000,58892,58971,59000,58720,172.36516448),array(1620516600000,58610,58897,58907.81331243,58505.209893,76.88514596),
//                   array(1620514800000,58580,58609,58781,58548,42.78093231),array(1620513000000,58965,58580,58965,58427,227.23224277),array(1620511200000,58806,58966.80906116,59091,58725.36463293,56.91851627),
//                   array(1620509400000,58854,58806,59082.96404475,58776,121.6938091),array(1620507600000,58940,58854,58974.963606,58711,92.78175983),array(1620505800000,59443,58936,59450,58805,142.05284896),
//                   array(1620504000000,59050,59443,59444,58805,227.27152964),array(1620502200000,59126.1183851,59059,59199,58943.0867238,133.50363313),array(1620500400000,59069,59125.997274,59297,58986.01485,89.23615041000001),
//                   array(1620498600000,59050,59054,59268,58949,129.18650796),array(1620496800000,58927.074882,59050,59230.063155,58921,123.27569939),
//                   array(1620495000000,58735.09522917,58926.153945,58940.9001461,58693.74019515,96.80500899),array(1620493200000,58424,58735.519986,59046.80792124,58204.139337,246.38598905),
//                   array(1620491400000,58167,58424,58536,58050,171.26213577),array(1620489600000,57637,58153,58439,57635.921208,184.71255602),array(1620487800000,58706.06116644,57611,58739,57519,599.35581829),
//                   array(1620486000000,58978,58704,58993,58502,146.32986377),array(1620484200000,58726.310616,58980,59072,58706,242.74743241),array(1620482400000,58825.10324439,58747,58933,58611,190.84421883),
//                   array(1620480600000,59281.22494314,58830,59432.0494217,58820,212.12405475),array(1620478800000,58920,59279,59281,58744,148.93923878),array(1620477000000,58590,58918,59125.997274,58490,158.48440875),
//                   array(1620475200000,58615,58590,58653,58289,114.29997099),array(1620473400000,58642,58614.65160824,58830,58459,144.59673714),array(1620471600000,58595,58652,58697,58492.4037418,144.53262682),
//                   array(1620469800000,58854,58612,58938.13733457,58400,117.2849453),array(1620468000000,58847,58854,58869,58701,76.01449431),array(1620466200000,59153.51086749,58847,59154,58724,89.45462444),
//                   array(1620464400000,58918,59152,59187,58707,135.56862446),array(1620462600000,59169,58911.418953,59330,58788,266.49325188),array(1620460800000,58531,59169.32308638,59367.58422135,58226.16044986,1351.90781104),
//                   array(1620459000000,58094,58528,58594,58071,186.47129984),array(1620457200000,57828,58094.80013012,58134,57647,55.18860738),array(1620455400000,57800,57837,57837,57555.25474195,47.08731363),
//                   array(1620453600000,57916.06766197,57800.498358,58005,57652,40.61031443),array(1620451800000,57918,57925,58024,57840,54.71854956),array(1620450000000,58108,57916,58108,57853.25994492,70.15441962),
//                   array(1620448200000,58361,58109,58416,58037,64.99692798),array(1620446400000,58120.96251,58361,58625.62625509,58000,157.78099053),array(1620444600000,58150,58154,58289,58026,57.98854744),
//                   array(1620442800000,58282,58150,58418,58150,104.61671307),array(1620441000000,57666,58282,58309,57651,194.75549098),array(1620439200000,57596.61546909,57631,57734,57551,30.18596478),
//                   array(1620437400000,57543,57579.02923668,57809,57427,74.16074666),array(1620435600000,57720.68057115,57533.36659353,57720.68057115,57524.22837584,33.37232714),
//                   array(1620433800000,57296,57706.29270847,57775,57295,50.98138245),array(1620432000000,57342,57296,57583,56939,84.9088965),array(1620430200000,57305.06039349,57349,57400,57215,52.54339565),
//                   array(1620428400000,57057,57305.06039349,57305.06039349,57055,97.76896933),array(1620426600000,57051,57033,57194,56800,104.02899847),array(1620424800000,57369,57051,57578,56911,191.59672953),
//                   array(1620423000000,57411,57368,57612.18229767,57270,131.41432966),array(1620421200000,57646,57411,57646,57176.145786,107.8951097),array(1620419400000,57771,57646,57826,57389,70.8098581),
//                   array(1620417600000,57614.020308,57781,58088,57614.020308,102.88381818),array(1620415800000,57627,57611,57688,57461,74.23663364),array(1620414000000,57924,57625.84006767,58005,57533,180.74441908),
//                   array(1620412200000,58060.634268,57916,58146,57816,70.64639635),array(1620410400000,58129.54053,58060,58148.86704,57677,146.4699727),array(1620408600000,58320.92266154,58130,58380,58004,93.81555741),
//                   array(1620406800000,58300,58317,58635,58202,562.68752614),array(1620405000000,57652,58300,58300,57597,322.57730134),array(1620403200000,57576.8392528,57635,58036,57230.411713,347.8490145),
//                   array(1620401400000,57356,57575.43940698,57600,57212.29501722,211.18464187),array(1620399600000,57151,57367.69496406,57489,57120.66338454,203.37826749),array(1620397800000,57010,57151,57254,56921,116.71007303),
//                   array(1620396000000,57054,57010,57152.20823484,56807,173.96751509),array(1620394200000,57221,57053,57312.58052161,57007.95800983,177.84237015),array(1620392400000,57540,57206,57736,57184.9195057,242.12672857),
//                   array(1620390600000,56471,57535,57619,56471,673.90787163),array(1620388800000,56490.80679376,56471.840796,56665.18403645,56255,54.99859898),array(1620387000000,56638,56477,56806,56444.9460294,184.4435492),
//                   array(1620385200000,56467,56627,56668,56263,39.47739199),array(1620383400000,56452,56462,56709.3895835,56394,23.55345446),array(1620381600000,56287,56466,56706,56287,274.41832429),
//                   array(1620379800000,56291,56285,56540.03732309,56285,39.12972216),array(1620378000000,56138,56295,56358,56111,90.45734350000001),array(1620376200000,55875.924852,56154.83640029,56180,55722,73.8727839),
//                   array(1620374400000,55807,55878,56073,55626,171.69958737),array(1620372600000,56217.50846682,55801,56229,55731,118.67701253),array(1620370800000,56142,56209,56243.52628517,56028.0310254,248.88938319),
//                   array(1620369000000,56027,56141,56216.4118126,55955,25.25504538),array(1620367200000,55845,56012,56152.26424311,55690,47.47983194),array(1620365400000,55994.64698619,55846,56132,55846,16.2909047),
//                   array(1620363600000,55862,55994.43865137,56018,55769.54637165,29.7388629),array(1620361800000,55477,55846.4010716,55915,55300,40.73152608),
//                   array(1620360000000,55755,55474.29417204,55863.63727956,55410,89.90488282),array(1620358200000,55654,55754,55984,55555,33.73480385),array(1620356400000,55852,55648.54309078,56133,55564,99.63103351),
//                   array(1620354600000,55936,55850,55989,55555,163.35263149),array(1620352800000,56215.2841768,55936,56406,55936,55.12030809),array(1620351000000,56258,56215.457568,56319,55990.87932,69.66610802),
//                   array(1620349200000,56431,56257,56562,55983.16107628,141.86152299),array(1620347400000,56794.72041018,56440.7544659,56854,56427,151.66859368),array(1620345600000,56451,56792,57089,56102,193.30651522),
//                   array(1620343800000,56549.3801537,56450,56789,56338.79286942,105.97046821),array(1620342000000,56513.67488216,56544,56666,56299,108.54101108),array(1620340200000,56276,56514,56539,56275,60.2646428),
//                   array(1620338400000,56314,56259,56449,56207,53.164779610000004),array(1620336600000,56250.08685666,56314,56463,56200,44.75522977),array(1620334800000,55913,56250,56337,55895,174.75868571),
//                   array(1620333000000,55996,55921,56250,55823,101.96066891),array(1620331200000,56128,55996,56167,55734,186.73287483000001),array(1620329400000,55648,56134,56307,55648,505.42140712),
//                   array(1620327600000,55762,55648,55938,55282,623.20405881),array(1620325800000,56747.52675257,55780,56783,55587.90447705,1735.37081724),array(1620324000000,56835,56747,56991,56747,219.58466486),
//                   array(1620322200000,57023,56835,57120,56810,131.28834167),array(1620320400000,56783.55649428,57028,57050,56783,76.97048014),array(1620318600000,57261,56783,57295.915072,56700,244.85928778),
//                   array(1620316800000,57120,57258,57454,56881.08762567,278.4955949),array(1620315000000,57039,57124,57384,56783,464.27485689),array(1620313200000,57185.32309456,57039,57263,56916.370005,245.36424542),
//                   array(1620311400000,57295.189308,57185,57400,57184,167.63702732),array(1620309600000,57337.98213,57292,57454,57025,181.52389034),array(1620307800000,57471,57337,57585,57177,94.43297322),
//                   array(1620306000000,57698,57466.15292,57760,57279,144.57244882),array(1620304200000,57856,57690,57856,57538,52.7850753),array(1620302400000,58034.1162768,57855,58190,57678,107.83917202),
//                   array(1620300600000,57882,58033,58172.78730779,57811,89.79581229),array(1620298800000,58028,57883,58062,57757,197.17357943),array(1620297000000,58303,58028,58343,57958.89428,133.99707621),
//                   array(1620295200000,57302,58302,58333,57211,802.49865745),array(1620293400000,57166,57302,57369,57092.1027185,199.00570966),array(1620291600000,56964,57173,57182,56851,162.33430284),
//                   array(1620289800000,57219,56964,57236,56901,69.24438778),array(1620288000000,56888,57219,57242,56865.37574652,109.71047243),array(1620286200000,56853,56907,56973,56728,38.52617397),
//                   array(1620284400000,56670,56853,56854,56426,73.93792939),array(1620282600000,56960,56671,56960,56553,310.75600928),array(1620280800000,57223,56961.602763,57223,56871.10202202,31.37228105),
//                   array(1620279000000,57120,57223,57401,56966,63.608883739999996),array(1620277200000,56974.61281905,57129,57129,56835,83.66351667),array(1620275400000,57431,56983,57599,56886,179.03432926),
//                   array(1620273600000,56843,57430.2965776,57432,56761,28.09179546),array(1620271800000,56827.1837661,56846,56914.38734464,56700,14.25187071),
//                   array(1620270000000,57035.3399704,56827.1837661,57035.3399704,56778,32.27346318),array(1620268200000,57129,57036,57144.40118523,56887,22.6956018),
//                   array(1620266400000,56813,57123,57140,56753,74.7794003),array(1620264600000,56967,56856,57150,56813,308.50226851),array(1620262800000,56997,56972,56997,56651,225.85042131),
//                   array(1620261000000,56938,57000,57192.42012257,56661,438.89010608),array(1620259200000,57486.600444,56939,57500,56751,638.91412023),array(1620257400000,57208,57487,57500,57177,36.469425720000004),
//                   array(1620255600000,57158,57230,57407,56971,127.14205537),array(1620253800000,57565,57151,57650,57148,160.36689731),array(1620252000000,56855,57562,57570.74323855,56820.6379832,140.7637162),
//                   array(1620250200000,56950,56880,57006,56775,41.98910728),array(1620248400000,56905,56950,57024,56801,152.22636463999999),array(1620246600000,56859,56923,56995,56566,186.918608),
//                   array(1620244800000,57167,56875,57253.79941297,56711,184.86188088),array(1620243000000,57322.40723607,57157,57367,57090,57.68463018),array(1620241200000,57326.408916,57323,57500,57277,63.75444383),
//                   array(1620239400000,57348,57326.408916,57500,57097.1136731,65.47114527),array(1620237600000,57316,57344,57475,57290,158.34300232),array(1620235800000,57604,57300,57697,57298,72.84291837),
//                   array(1620234000000,57430,57596.44123616,57737,57298.93087133,64.20969563),array(1620232200000,57581.220944,57425,57748,57284,127.98663664),array(1620230400000,57615,57579.4098518,57898,57456,405.62810816),
//                   array(1620228600000,57080,57592,57656,57047,339.73201686),array(1620226800000,57006,57080,57434,56988.87948676,660.50322239),array(1620225000000,55854,57005,57050,55854,500.90608623),
//                   array(1620223200000,56277,55895.24897208,56331,55726,185.62654872),array(1620221400000,55931,56277,56277.44777175,55799.534128,165.1961181),array(1620219600000,55653,55931,56066,55604,187.9600219),
//                   array(1620217800000,55480,55653,55699.01458109,55337,80.24304278),array(1620216000000,55156,55481.27681218,55824,55130,153.96299302),array(1620214200000,55256,55156,55323,55011,85.42453864),
//                   array(1620212400000,55692.352716,55257,55716,55188,56.84092667),array(1620210600000,55269.09502035,55691,55856,55269.09502035,151.36350482),array(1620208800000,55402.3081231,55258,55509,55093,106.73302819),
//                   array(1620207000000,55180,55399,55427,55180,41.35364234),array(1620205200000,55447,55160,55489,55108,74.05447555),array(1620203400000,55254,55446.488608,55548,55186.4971458,282.89909536),
//                   array(1620201600000,54888,55254.39645728,55254.39645728,54736,193.77299464),array(1620199800000,54561,54865.3886169,55050,54553,128.99942915),array(1620198000000,54461,54561,54600,54366.17752604,22.86729733),
//                   array(1620196200000,54322,54469,54483,53962,102.92832102),array(1620194400000,54711.29656546,54343,54760,54122,81.74780617),array(1620192600000,54651,54707,54932.67883199,54484.03844951,38.74994735),
//                   array(1620190800000,54555,54655,54746.76285994,54326,108.79857623),array(1620189000000,54828,54555,55297,54511,79.85475178),array(1620187200000,54838,54820,55000,54761.80541201,26.469167510000002),
//                   array(1620185400000,55045.186214,54817,55229,54755,193.25857985),array(1620183600000,55082,55045.186214,55189,54900,127.51721535),array(1620181800000,55199.191248,55083,55346.63792504,54966,41.68292592),
//                   array(1620180000000,54759,55199,55425,54656,138.03876861),array(1620178200000,54773,54761,54870,54548.4047352,190.13879438),array(1620176400000,54573,54775,55067,54573,163.66787364),
//                   array(1620174600000,54010,54572,54963,54010,510.7365074),array(1620172800000,53251,54018,54036,52960,396.21518834),array(1620171000000,54057,53251,54205,53067,581.64917507),
//                   array(1620169200000,54097.0055683,54063.959712,54280,53850,99.54325693),array(1620167400000,53976.93139493,54097,54131,53590,189.4345001),array(1620165600000,54380,53995,54416,53962.8964548,41.77410125),
//                   array(1620163800000,54615,54365,54620,54212,61.33440196),array(1620162000000,54778,54605,54803.881664,54461,33.94046731),
//                   array(1620160200000,54017,54745,54833,53928,86.92774014)*/
//
//                )
//            );
//            return response()->json($data);
//        }
//        else{
//            $Bitfinex = new Bitfinex();
//            $response = $Bitfinex->getCandle($request->currency);
//            $balance = UserWallet::whereHas('currency', function($query) use ($request){
//                return $query->where('name', $request->user_currency);
//            })->where('user_id', Auth::user()->id)->first();
//            if($balance) $balance = $balance->balance;
//            else $balance = 0;
//            return response()->json(['status' => true, 'chartData' => $response, 'balance' => $balance]);
//        }
        /*$Bitfinex = new Bitfinex();
        $response = $Bitfinex->getCandle($request->currency);
        $balance = UserWallet::whereHas('currency', function($query) use ($request){
            return $query->where('name', $request->user_currency);
        })->where('user_id', Auth::user()->id)->first();
        if($balance) $balance = $balance->balance;
        else $balance = 0;
        return response()->json(['status' => true, 'chartData' => $response, 'balance' => $balance]);*/
    }

    public function buy(Request $request)
    {
        $currency = Currency::where('name', $request->currency)->first();
        if(!$currency) return response()->json(['status' => false]);
        $UserWallet = UserWallet::where('user_id', Auth::user()->id)->where('currency_id', $currency->id)->first();
        //For saving Trade data in User Wallet table
        if (!isset($request->leverage)){
            if(!$UserWallet) {
                $UserWallet = new UserWallet();
                $UserWallet->balance = $request->buyAmount;
                $UserWallet->equivalent_trade_amount = $request->calcBuyAmount;

            }else{
                $UserWallet->balance = $UserWallet->balance+$request->buyAmount;
                $UserWallet->equivalent_trade_amount = $UserWallet->equivalent_trade_amount + $request->calcBuyAmount;
            }
            $UserWallet->user_id = Auth::user()->id;
            $UserWallet->currency_id = $currency->id;
            $UserWallet->save();
        }

        //For saving Trade & derivative Amount in User table(derivative/balance)
        $leverage = 1;
        if(isset($request->leverage)){
            $leverage = $request->leverage;
            Auth::user()->derivative = Auth::user()->derivative - $request->calcBuyAmount / $leverage;
        }else{
            Auth::user()->balance = Auth::user()->balance - $request->calcBuyAmount;
        }
        Auth::user()->save();
//        derivativeLoan
        try{
            $TransactionHistory= new TransactionHistory();
            $TransactionHistory->amount = $request->buyAmount;
            $TransactionHistory->equivalent_amount = $request->calcBuyAmount;
            $TransactionHistory->derivativeUserMoney = $request->derivativeUserMoney;
            if ($request->derivativeLoan == 0){
                $TransactionHistory->derivativeLoan = 0;
            }else{
                $TransactionHistory->derivativeLoan = $request->calcBuyAmount - $request->derivativeUserMoney;
            }
            $TransactionHistory->type = 1;
            $TransactionHistory->leverage = $leverage;
            $TransactionHistory->user_id = Auth::user()->id;
            $TransactionHistory->currency_id = $currency->id;
            $TransactionHistory->save();

            if(isset($request->leverage)) {
                $LeverageWallet = new Leverage_Wallet();
                $LeverageWallet->amount = $request->buyAmount;
                $LeverageWallet->equivalent_amount = $request->calcBuyAmount;
                $LeverageWallet->derivativeUserMoney = $request->derivativeUserMoney;
                $LeverageWallet->derivativeLoan = $request->calcBuyAmount - $request->derivativeUserMoney;
                $LeverageWallet->type = 1;
                $LeverageWallet->leverage = $leverage;
                $LeverageWallet->user_id = Auth::user()->id;
                $LeverageWallet->currency_id = $currency->id;
                $LeverageWallet->save();
            }
        } catch(Exception $e){
            return response()->json(['status' => false]);
        }
       return response()->json(['status' => true]);
    }

    public function sell(Request $request)
    {
//        dd($request->all());
        $leverageRequestSellAmount = $request->sellAmount;
        $equivalentSellAmount = $request->calcSellAmount;

        $currency = Currency::where('name', $request->currency)->first();
        if(!$currency){
            return response()->json(['status' => false]);
        }

        DB::beginTransaction();
        try {
            if (isset($request->derivativeType)) {
//                $UserWallet->balance = $UserWallet->balance - $leverageRequestSellAmount;
//                $UserWallet->save();

                $leverageWalletCurrency = Leverage_Wallet::where('user_id', Auth::user()->id)->where('currency_id', $currency->id)->orderBy('id', 'desc')->get();
                $leverageSellAmount = $leverageRequestSellAmount;

                foreach ($leverageWalletCurrency as $item) {
                    $derivativeSells = new DerivativeSell();
                    $derivativeSells->type = $item->type;
                    $derivativeSells->status = $item->status;
                    $derivativeSells->user_id = $item->user_id;
                    $derivativeSells->currency_id = $item->currency_id;
                    $derivativeSells->leverage = $item->leverage;

                   if ($item->amount <= $leverageSellAmount) {
                        $sellTimeValue = ($equivalentSellAmount * $item->amount) / $leverageRequestSellAmount;
                        $sellAmountToUserWallet = $sellTimeValue - ($item->equivalent_amount * (($item->leverage - 1) / $item->leverage));

                        $derivativeSells->amount = $item->amount;
                        $derivativeSells->equivalent_amount = $item->equivalent_amount;
                        $derivativeSells->priceAtSell = $sellTimeValue;
                        $derivativeSells->profit = $sellTimeValue - $item->equivalent_amount;
                        $derivativeSells->save();

                        Auth::user()->derivative = Auth::user()->derivative + $sellAmountToUserWallet;
                        Auth::user()->save();

                        $leverageSellAmount -= $item->amount;
                        $item->delete();
                    } else {
                        $sellTimeValue = ($equivalentSellAmount * $leverageSellAmount) / $leverageRequestSellAmount;
                        $buyTimeValue = ($item->equivalent_amount * $leverageSellAmount) / $item->amount;
                        $sellAmountToUserWallet = $sellTimeValue - ($buyTimeValue * (($item->leverage - 1) / $item->leverage));

                        $derivativeSells->amount = $leverageSellAmount;
                        $derivativeSells->equivalent_amount = $buyTimeValue;
                        $derivativeSells->priceAtSell = $sellTimeValue;
                        $derivativeSells->profit = $sellTimeValue - $buyTimeValue;
                        $derivativeSells->save();

                        Auth::user()->derivative = Auth::user()->derivative + $sellAmountToUserWallet;
                        Auth::user()->save();

                        $item->amount = $item->amount - $leverageSellAmount;
                        $item->equivalent_amount = $item->equivalent_amount - $buyTimeValue;
                        $item->save();
                        $leverageSellAmount = 0;
                    }
                    if ($leverageSellAmount == 0) {
                        break;
                    }
                }

                $TransactionHistory = new TransactionHistory();
                $TransactionHistory->amount = $request->sellAmount;
                $TransactionHistory->equivalent_amount = $request->calcSellAmount;
                $TransactionHistory->type = 2;
                $TransactionHistory->user_id = Auth::user()->id;
                $TransactionHistory->currency_id = $currency->id;
                $TransactionHistory->save();

            }else{
                $TransactionHistory= new TransactionHistory();
                $TransactionHistory->amount = $request->sellAmount;
                $TransactionHistory->equivalent_amount = $request->calcSellAmount;
                $TransactionHistory->type = 2;
                $TransactionHistory->user_id = Auth::user()->id;
                $TransactionHistory->currency_id = $currency->id;
                $TransactionHistory->save();

                $UserWallet = UserWallet::where('user_id', Auth::user()->id)->where('currency_id', $currency->id)->first();
                if(!$UserWallet) return response()->json(['status' => false]);

                $UserWallet->balance = $UserWallet->balance-$request->sellAmount;
                $UserWallet->save();
                if ($UserWallet->balance == 0.00000000){
                    $UserWallet->delete();
                }

                Auth::user()->balance = Auth::user()->balance+$equivalentSellAmount;
                Auth::user()->save();
            }
        }
        catch(\Exception $e)
        {
            DB::rollback();
            return response()->json(['status' => false]);
        }
        DB::commit();
        return response()->json(['status' => true]);
    }

    public function getBuyOrders(Request $request)
    {
        $Bitfinex = new Bitfinex();
        return $Bitfinex->getOrderBook($request->currency);
    }
    public function limitBuy(Request $request){

        $currency = Currency::where('name', $request->currency)->first();
            $limitBuy = new LimitBuySell();
            $limitBuy->limitType = $request->limitType;
            $limitBuy->priceLimit = $request->priceLimit;
            $limitBuy->currencyAmount = $request->currencyAmount;
            $limitBuy->transactionStatus = $request->transactionStatus;
            $limitBuy->user_id = Auth::user()->id;
            $limitBuy->currency_id = $currency->id;
            if($request->derivative){
                $limitBuy->derivative = $request->derivative;
            }
            $limitBuy->save();


        return response()->json(['status' => true]);


    }
    public function limitSell(Request $request){
        $currency = Currency::where('name', $request->currency)->first();
        $limitSell = new LimitBuySell();
        $limitSell->limitType = $request->limitType;
        $limitSell->priceLimit = $request->priceLimit;
        $limitSell->currencyAmount = $request->currencyAmount;
        $limitSell->transactionStatus = $request->transactionStatus;
        $limitSell->user_id = Auth::user()->id;
        $limitSell->currency_id = $currency->id;
        if($request->derivative){

            $limitSell->derivative = $request->derivative;
        }
        $limitSell->save();

        return response()->json(['status' => true]);
    }

    public function getBuySellPendingData(Request $coinid){

        if($coinid->coin == 'MAB')
        {
            $coinname = 'ADA';
        }
        else{
            $coinname=$coinid->coin;
        }
        $currency = Currency::where('name', $coinname)->first();
        if($coinid->type === 'derivative')
        {
            $data = limitBuySell::select('id','priceLimit','currencyAmount','limitType')->where('user_id', Auth::user()->id)->where('currency_id', $currency->id)->where('transactionStatus', 1)->where('derivative','>', 0)->orderBy('created_at', 'DESC')->get();
        }
        else
        {
            $data = limitBuySell::select('id','priceLimit','currencyAmount','limitType')->where('user_id', Auth::user()->id)->where('currency_id', $currency->id)->where('transactionStatus', 1)->orderBy('created_at', 'DESC')->get();
        }
        if($data && count($data) > 0)
        {
            foreach ($data as $key => $val)
            {
                $table_data[$key] = $val;
            }
            return response()->json($table_data);
        }
        else
        {
           return "no data";

        }


    }

    public function limitDelete(Request $request){
        $limitBuy   = LimitBuySell::find($request->limitId);
        $limitBuy->delete();
        return response()->json(['status' => true]);


    }

}
